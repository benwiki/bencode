#:import dp kivy.metrics.dp
#:import Window kivy.core.window.Window

#:set PEACH_BG (1.0, 0.94, 0.91, 1.0)
#:set PEACH_CARD (1.0, 0.89, 0.84, 1.0)
#:set PEACH_ACCENT (0.96, 0.55, 0.42, 1.0)
#:set PEACH_ACCENT_DARK (0.88, 0.43, 0.30, 1.0)
#:set PEACH_ACCENT_LIGHT (0.98, 0.67, 0.57, 1.0)
#:set TEXT_DARK (0.25, 0.18, 0.16, 1.0)
#:set TEXT_MUTED (0.55, 0.52, 0.50, 1.0)

#:set BAR_H dp(52)
#:set MENU_H dp(44)
#:set MENU_GAP dp(6)


# Utility: hide/show a layout without it intercepting touches.
# Use by setting `shown: <expr>` on the instance.
# Optional: override shown_* to keep fixed height/width or None size_hints.
<ShownBoxLayout@BoxLayout>:
    shown: True
    shown_size_hint_y: None
    shown_height: dp(1)
    size_hint_x: (1 if self.shown else 0)
    size_hint_y: (self.shown_size_hint_y if self.shown else 0)
    width: (dp(1) if self.shown else 0)
    height: (self.shown_height if self.shown else 0)
    opacity: (1 if self.shown else 0)
    disabled: (not self.shown)


<MenuScreen>:
    BoxLayout:
        orientation: "vertical"
        padding: dp(12)
        spacing: dp(10)

        Label:
            text: app.text.app_title
            size_hint_y: None
            height: dp(40)
            color: TEXT_DARK
            font_size: "22sp"

        # Portrait: single column
        ShownBoxLayout:
            shown: (not root.is_landscape)
            shown_size_hint_y: 1
            orientation: "vertical"
            spacing: dp(10)

            PeachButton:
                text: "[b]{}[/b]".format(app.text.menu_practice)
                markup: True
                size_hint_y: None
                height: dp(48)
                on_release: root.go_practice()

            PeachButton:
                text: app.text.menu_add_word
                size_hint_y: None
                height: dp(48)
                on_release: setattr(app.root, "current", "add_word")

            PeachButton:
                text: app.text.menu_add_glossary
                size_hint_y: None
                height: dp(48)
                on_release: setattr(app.root, "current", "add_glossary")

            PeachButton:
                text: app.text.menu_settings
                size_hint_y: None
                height: dp(48)
                on_release: setattr(app.root, "current", "settings")

            PeachSecondaryButton:
                text: app.text.menu_quit
                size_hint_y: None
                height: dp(48)
                on_release: app.stop()

            Label:
                text: app.text.menu_languages_fmt(mlang=getattr(getattr(app, 'model', None), 'mlang', ''), learnlang=getattr(getattr(app, 'model', None), 'learnlang', ''))
                size_hint_y: None
                height: dp(26)
                color: TEXT_DARK

        # Landscape: two columns, 50/50 width
        ShownBoxLayout:
            shown: root.is_landscape
            shown_size_hint_y: 1
            orientation: "horizontal"
            spacing: dp(10)

            BoxLayout:
                orientation: "vertical"
                spacing: dp(10)
                size_hint_x: 0.5

                PeachButton:
                    text: "[b]{}[/b]".format(app.text.menu_practice)
                    markup: True
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.go_practice()

                PeachButton:
                    text: app.text.menu_add_word
                    size_hint_y: None
                    height: dp(48)
                    on_release: setattr(app.root, "current", "add_word")

                PeachButton:
                    text: app.text.menu_add_glossary
                    size_hint_y: None
                    height: dp(48)
                    on_release: setattr(app.root, "current", "add_glossary")

                Widget:
                    size_hint_y: 1

            BoxLayout:
                orientation: "vertical"
                spacing: dp(10)
                size_hint_x: 0.5

                PeachButton:
                    text: app.text.menu_settings
                    size_hint_y: None
                    height: dp(48)
                    on_release: setattr(app.root, "current", "settings")

                PeachSecondaryButton:
                    text: app.text.menu_quit
                    size_hint_y: None
                    height: dp(48)
                    on_release: app.stop()

                Widget:
                    size_hint_y: 1

                Label:
                    text: app.text.menu_languages_fmt(mlang=getattr(getattr(app, 'model', None), 'mlang', ''), learnlang=getattr(getattr(app, 'model', None), 'learnlang', ''))
                    size_hint_y: None
                    height: dp(26)
                    color: TEXT_DARK


<PracticeScreen>:
    BoxLayout:
        orientation: "vertical"
        padding: dp(12)
        spacing: dp(10)

        ShownBoxLayout:  # Portrait top bar (full-width)
            shown: (not root.is_landscape)
            shown_height: dp(48)
            orientation: "horizontal"
            spacing: MENU_GAP

            BackArrowSquare:
                size_hint_x: None
                width: dp(52)
                on_release: root.go_menu()

            PeachButton:
                text: app.text.practice_return_to_menu
                on_release: root.go_menu()

        BoxLayout:  # Main area: portrait stacks (history grows), landscape splits 50/50 (history left, everything else right).
            orientation: ("horizontal" if root.is_landscape else "vertical")
            size_hint_y: 1
            spacing: dp(10)

            BoxLayout:  # History card: in portrait it expands to fill remaining space.
                orientation: "vertical"
                size_hint_x: (0.5 if root.is_landscape else 1)
                size_hint_y: 1
                spacing: dp(6)
                canvas.before:
                    Color:
                        rgba: PEACH_CARD
                    Rectangle:
                        pos: self.pos
                        size: self.size

                ScrollView:
                    id: history_scroll
                    do_scroll_x: False
                    scroll_y: 0

                    AnchorLayout:
                        anchor_x: "left"
                        anchor_y: "bottom"
                        size_hint_y: None
                        height: max(history_lbl.texture_size[1], history_scroll.height)

                        Label:
                            id: history_lbl
                            text: ""
                            markup: True
                            size_hint_y: None
                            halign: "left"
                            color: TEXT_DARK
                            text_size: self.width, None
                            height: self.texture_size[1]

            BoxLayout:  # Controls panel: in landscape fills the right half; in portrait uses minimum height.
                orientation: "vertical"
                size_hint_x: (0.5 if root.is_landscape else 1)
                size_hint_y: (1 if root.is_landscape else None)
                height: (0 if root.is_landscape else self.minimum_height)
                spacing: 0

                ShownBoxLayout:  # Landscape top bar (right half only)
                    shown: root.is_landscape
                    shown_height: dp(48)
                    orientation: "horizontal"
                    spacing: MENU_GAP

                    BackArrowSquare:
                        size_hint_x: None
                        width: dp(52)
                        on_release: root.go_menu()

                    PeachButton:
                        text: app.text.practice_return_to_menu
                        on_release: root.go_menu()

                # Push the (ended/active) labels + input toward the bottom.
                # In portrait, this collapses to ~0 because this panel uses minimum_height.
                # In landscape, it absorbs the extra space.
                Widget:

                ShownBoxLayout:  # Ended panel (score summary)
                    id: ended_panel
                    shown: root.ended
                    shown_height: self.minimum_height
                    orientation: "vertical"
                    spacing: dp(6)

                    Label:
                        id: summary_lbl
                        text: ""
                        size_hint_y: None
                        halign: "left"
                        valign: "top"
                        color: TEXT_DARK
                        text_size: self.width, None
                        height: max(self.texture_size[1], 0)

                ShownBoxLayout:  # Active panel (normal practice UI) - excludes bottom controls.
                    id: active_panel
                    shown: (not root.ended)
                    shown_height: self.minimum_height
                    orientation: "vertical"
                    spacing: 0

                    BoxLayout:  # Word + type
                        orientation: "horizontal"
                        size_hint_y: None
                        height: dp(40)
                        spacing: dp(10)

                        Label:
                            id: word_lbl
                            text: ""
                            size_hint_y: None
                            height: dp(40)
                            halign: "left"
                            valign: "middle"
                            color: TEXT_DARK
                            font_size: "22sp"
                            text_size: self.size

                        Label:
                            id: type_lbl
                            text: ""
                            size_hint: None, None
                            height: dp(40)
                            width: (self.texture_size[0] + dp(12) if self.text else 0)
                            opacity: (1 if self.text else 0)
                            halign: "left"
                            valign: "middle"
                            color: TEXT_MUTED
                            font_size: "16sp"
                            text_size: None, None

                    Label:
                        id: prompt_lbl
                        text: ""
                        size_hint_y: None
                        height: dp(26)
                        halign: "left"
                        valign: "middle"
                        color: TEXT_DARK
                        font_size: "16sp"
                        text_size: self.size

                    Label:
                        id: status_lbl
                        text: ""
                        size_hint_y: None
                        height: dp(22)
                        halign: "left"
                        valign: "middle"
                        color: TEXT_MUTED
                        text_size: self.size

                    TextInput:
                        id: answer_input
                        multiline: False
                        size_hint_y: None
                        height: dp(44)
                        on_text_validate: root.next_action()

                Widget:  # Spacer between active panel and bottom controls.
                    size_hint_y: None
                    height: dp(6)

                ShownBoxLayout:  # Bottom controls (inside the controls panel for both orientations).
                    shown: (not root.ended)
                    shown_height: (BAR_H + (MENU_H + MENU_GAP if root.menu_open else 0))
                    orientation: "vertical"
                    spacing: (MENU_GAP if root.menu_open else 0)

                    ShownBoxLayout:
                        shown: root.menu_open
                        shown_height: MENU_H
                        orientation: "horizontal"
                        spacing: dp(6)

                        PeachButton:
                            text: app.text.practice_menu_learned
                            on_release: root.do_learned()

                        PeachButton:
                            text: app.text.practice_menu_hard
                            on_release: root.do_hard()

                        PeachButton:
                            text: app.text.practice_menu_stop
                            on_release: root.do_stop()

                    BoxLayout:
                        orientation: "horizontal"
                        size_hint_y: None
                        height: BAR_H
                        spacing: MENU_GAP

                        HamburgerSquare:
                            size_hint: None, None
                            width: dp(52)
                            height: BAR_H
                            on_release: root.toggle_menu()

                        PeachButton:
                            text: app.text.practice_next
                            size_hint_y: None
                            height: BAR_H
                            on_release: root.next_action()


<SettingsScreen>:
    BoxLayout:
        orientation: "vertical"
        padding: dp(12)
        spacing: dp(10)

        # App bar
        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: dp(48)
            spacing: dp(10)

            BackArrowSquare:
                size_hint: None, None
                width: dp(48)
                height: dp(48)
                on_release: setattr(app.root, "current", "menu")

            Label:
                text: app.text.settings_title
                size_hint_y: None
                height: dp(48)
                halign: "center"
                valign: "middle"
                color: TEXT_DARK
                font_size: "22sp"
                text_size: self.size

            Widget:
                size_hint_x: None
                width: dp(48)

        # Body: portrait stacks; landscape splits 50/50.
        BoxLayout:
            orientation: ("horizontal" if root.is_landscape else "vertical")
            size_hint_y: 1
            spacing: dp(10)

            BoxLayout:
                orientation: "vertical"
                size_hint_x: (0.5 if root.is_landscape else 1)
                size_hint_y: 1
                spacing: dp(10)

                Label:
                    text: app.text.settings_ui_language
                    size_hint_y: None
                    height: dp(22)
                    halign: "left"
                    valign: "middle"
                    color: TEXT_DARK
                    text_size: self.size

                BoxLayout:
                    id: lang_options_host
                    orientation: "vertical"
                    size_hint_y: 1

            BoxLayout:
                orientation: "vertical"
                size_hint_x: (0.5 if root.is_landscape else 1)
                size_hint_y: (1 if root.is_landscape else None)
                height: (self.minimum_height if not root.is_landscape else 0)
                spacing: dp(10)

                BoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)

                    Label:
                        text: app.text.settings_auto_continue
                        halign: "left"
                        valign: "middle"
                        color: TEXT_DARK
                        text_size: self.size

                    Switch:
                        active: root.auto_continue
                        on_active: root.set_auto_continue(self.active)

                BoxLayout:
                    orientation: "horizontal"
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)

                    Label:
                        text: app.text.settings_case_sensitive
                        halign: "left"
                        valign: "middle"
                        color: TEXT_DARK
                        text_size: self.size

                    Switch:
                        active: root.case_sensitive
                        on_active: root.set_case_sensitive(self.active)

                Label:
                    text: app.text.settings_data_folder
                    size_hint_y: None
                    height: dp(22)
                    halign: "left"
                    valign: "middle"
                    color: TEXT_DARK
                    text_size: self.size

                TextInput:
                    text: root.data_dir
                    readonly: True
                    multiline: True
                    size_hint_y: None
                    height: dp(58)
                    cursor_blink: False
                    background_normal: ""
                    background_active: ""
                    background_color: PEACH_CARD
                    foreground_color: TEXT_DARK
